name: Archive 9000

on:
  workflow_dispatch:

jobs:
  archive.9000:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@latest

      - name: Download Files (url.txt)
        run: |
          mkdir -p downloads

          DOWNLOADS_DIR="${GITHUB_WORKSPACE}/downloads"
          while read -r url; do
            [ -z "$url" ] && continue
            filename=$(basename "$url")
            # Try curl first, fallback to wget if curl fails
            if ! curl -fsSL "$url" -o "${DOWNLOADS_DIR}/$filename"; then
              wget -q "$url" -O "${DOWNLOADS_DIR}/$filename" || echo "Failed to download $url"
            fi
          done < "${GITHUB_WORKSPACE}/url.txt"

      - name: Compress, Commit, Push
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          DOWNLOADS_DIR="${GITHUB_WORKSPACE}/downloads"
          cd "$DOWNLOADS_DIR"
          shopt -s nullglob
          for file in *; do
            [ -f "$file" ] && xz -9 -e -k "$file" && rm "$file"
          done

          if ls *.xz 1> /dev/null 2>&1; then
            tar -cJf "${GITHUB_WORKSPACE}/downloads_double_compressed.tar.xz" *.xz && rm *.xz
          fi

          cd "${GITHUB_WORKSPACE}"
          DATE_STR=$(date +"%Y/%m/%d")
          git add downloads/ downloads_double_compressed.tar.xz
          git commit -m "${DATE_STR} Update" || exit 0
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
